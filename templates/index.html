<script>
    let batteryData = [];
    let timestamps = [];

    async function fetchStatus() {
        const response = await fetch('/status');
        const data = await response.json();
        document.getElementById('battery').innerText = `${data.battery_level}%`;
        document.getElementById('solar').innerText = data.solar_panel_on ? "On" : "Off";
        document.getElementById('heating').innerText = data.heating_pad_on ? "On" : "Off";
        document.getElementById('temperature').innerText = `${data.temperature}Â°C`;

        // Add new live data point
        timestamps.push(data.timestamp);
        batteryData.push(data.battery_level);

        Plotly.update('batteryGraph', {
            x: [timestamps],
            y: [batteryData]
        });
    }

    async function fetchHistory() {
        const response = await fetch('/history');
        const history = await response.json();

        // Reset existing data
        batteryData = [];
        timestamps = [];

        // Fill in from history
        history.forEach(entry => {
            timestamps.push(entry.timestamp);
            batteryData.push(parseFloat(entry.battery_level));
        });

        // Plot initial graph
        Plotly.newPlot('batteryGraph', [{
            x: timestamps,
            y: batteryData,
            mode: 'lines+markers',
            line: { color: '#1f77b4' }
        }], {
            title: 'Battery Level (%) vs Time',
            xaxis: { title: 'Time' },
            yaxis: { title: 'Battery Level (%)', range: [0, 100] }
        });
    }

    async function fetchImages() {
        const response = await fetch('/list_images');
        const files = await response.json();
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        for (const file of files) {
            const imgCard = document.createElement('div');
            imgCard.className = 'img-card';
            imgCard.innerHTML = `
                <img src="/img/${file}" alt="${file}">
                <p>${file}</p>
            `;
            gallery.appendChild(imgCard);
        }
    }

    async function refreshDashboard() {
        await fetchStatus();
        await fetchImages();
    }

    async function initializeDashboard() {
        await fetchHistory();
        await fetchImages();
    }

    initializeDashboard(); // load old history first
    setInterval(refreshDashboard, 5000); // refresh live every 10 sec
</script>
