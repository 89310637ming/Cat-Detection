<script>
    let batteryData = [];
    let timestamps = [];
    let dashboardInitialized = false;

    async function fetchStatus() {
        if (!dashboardInitialized) return;

        const response = await fetch('/status');
        const data = await response.json();
        document.getElementById('battery').innerText = `${data.battery_level}%`;
        document.getElementById('solar').innerText = data.solar_panel_on ? "On" : "Off";
        document.getElementById('heating').innerText = data.heating_pad_on ? "On" : "Off";
        document.getElementById('temperature').innerText = `${data.temperature}Â°C`;

        timestamps.push(data.timestamp);
        batteryData.push(parseFloat(data.battery_level));

        Plotly.update('batteryGraph', {
            x: [timestamps],
            y: [batteryData]
        });
    }

    async function fetchHistory() {
        try {
            const response = await fetch('/history');
            const history = await response.json();

            batteryData = [];
            timestamps = [];

            if (Array.isArray(history) && history.length > 0) {
                history.forEach(entry => {
                    timestamps.push(entry.timestamp);
                    batteryData.push(parseFloat(entry.battery_level));
                });
            }

            // Always initialize an empty or full plot
            await Plotly.newPlot('batteryGraph', [{
                x: timestamps,
                y: batteryData,
                mode: 'lines+markers',
                line: { color: '#1f77b4' }
            }], {
                title: 'Battery Level (%) vs Time',
                xaxis: { title: 'Time' },
                yaxis: { title: 'Battery Level (%)', range: [0, 100] }
            });

            dashboardInitialized = true;  // Now ready to start refreshing
        } catch (error) {
            console.error("Failed to load history:", error);
        }
    }

    async function fetchImages() {
        const response = await fetch('/list_images');
        const files = await response.json();
        const gallery = document.getElementById('gallery');
        gallery.innerHTML = "";
        for (const file of files) {
            const imgCard = document.createElement('div');
            imgCard.className = 'img-card';
            imgCard.innerHTML = `
                <img src="/img/${file}" alt="${file}">
                <p>${file}</p>
            `;
            gallery.appendChild(imgCard);
        }
    }

    async function refreshDashboard() {
        await fetchStatus();
        await fetchImages();
    }

    async function initializeDashboard() {
        await fetchHistory();   // Fetch history FIRST safely
        await fetchImages();
        setInterval(refreshDashboard, 10000); // Start refreshing only AFTER successful plotting
    }

    initializeDashboard();
</script>
